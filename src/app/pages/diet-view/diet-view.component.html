<div class="view-container" *ngIf="diet">
  <!-- HEADER CON TÍTULO O INPUT -->
  <div class="header">
    <ng-container *ngIf="!editMode; else editTitle">
      <h1>{{ diet.title }}</h1>
    </ng-container>
    <ng-template #editTitle>
      <input
        type="text"
        [(ngModel)]="updated.title"
        placeholder="Título de la dieta"
      />
    </ng-template>
  </div>

  <!-- SECCIÓN DESCRIPCIÓN GENERAL -->
  <div class="section overview">
    <label>Descripción general:</label>
    <ng-container *ngIf="!editMode; else editDesc">
      <p>{{ diet.description1 }}</p>
    </ng-container>
    <ng-template #editDesc>
      <textarea
        [(ngModel)]="updated.description1"
        placeholder="Descripción general"
      ></textarea>
    </ng-template>
  </div>

  <!-- SECCIÓN COMIDAS -->
  <div class="section">
    <div class="meals-header">
      <h2>Comidas ({{ editMode ? updated.meals.length : diet.meals.length }})</h2>
      <button
        type="button"
        *ngIf="editMode"
        class="btn-add"
        [disabled]="updated.meals.length >= 10"
        (click)="addMeal()"
      >
        + Añadir comida
      </button>
    </div>

    <div class="meals">
      <div
        *ngFor="let m of (editMode ? updated.meals : diet.meals); let i = index"
        class="meal-card"
      >
        <!-- TÍTULO DE LA COMIDA -->
        <div class="meal-section meal-title">
          <h4>Comida del día</h4>
          <div class="title-row">
            <ng-container *ngIf="!editMode; else editMealTitle">
              <h3>{{ m.lunch }}</h3>
            </ng-container>
            <ng-template #editMealTitle>
              <input
                type="text"
                [(ngModel)]="updated.meals[i].lunch"
                placeholder="Nombre de la comida"
              />
            </ng-template>
            <button
              type="button"
              *ngIf="editMode"
              class="btn-remove"
              [disabled]="updated.meals.length <= 1"
              (click)="removeMeal(i)"
            >
              ×
            </button>
          </div>
        </div>

        <!-- CONTENIDO Y PREPARACIÓN -->
        <div class="meal-section meal-content">
          <h4>Contenido y preparación</h4>
          <ng-container *ngIf="!editMode; else editMeal">
            <p>{{ m.description2 }}</p>
          </ng-container>
          <ng-template #editMeal>
            <textarea
              [(ngModel)]="updated.meals[i].description2"
              placeholder="Descripción detallada"
            ></textarea>
          </ng-template>
        </div>

        <!-- MACROS (modo lectura solo si hay datos) -->
        <div
          class="meal-section meal-macros"
          *ngIf="
            !editMode &&
            (m.proteins || m.carbohydrates || m.fats || m.calories)
          "
        >
          <h4>Macros</h4>
          <ul class="macros">
            <li *ngIf="m.proteins">Proteínas: {{ m.proteins }} g</li>
            <li *ngIf="m.carbohydrates">
              Carbohidratos: {{ m.carbohydrates }} g
            </li>
            <li *ngIf="m.fats">Grasas: {{ m.fats }} g</li>
            <li *ngIf="m.calories">Calorías: {{ m.calories }} kcal</li>
          </ul>
        </div>

        <!-- CAMPOS DE EDICIÓN DE MACROS E IMAGEN -->
        <ng-container *ngIf="editMode">
          <div class="meal-section meal-macros">
            <h4>Macros</h4>
            <div class="inputs-row">
              <input
                type="number"
                [(ngModel)]="updated.meals[i].proteins"
                placeholder="Proteínas (g)"
              />
              <input
                type="number"
                [(ngModel)]="updated.meals[i].carbohydrates"
                placeholder="Carbohidratos (g)"
              />
            </div>
            <div class="inputs-row">
              <input
                type="number"
                [(ngModel)]="updated.meals[i].fats"
                placeholder="Grasas (g)"
              />
              <input
                type="number"
                [(ngModel)]="updated.meals[i].calories"
                placeholder="Calorías"
              />
            </div>
          </div>
          <div class="meal-section meal-image">
            <h4>Imagen</h4>
            <div class="file-input">
              <input
                type="file"
                accept="image/*"
                (change)="onFileSelected($event, updated.meals[i])"
              />
            </div>
            <img
              *ngIf="updated.meals[i].img_url"
              [src]="updated.meals[i].img_url"
              alt="Preview comida"
              class="meal-img"
            />
          </div>
        </ng-container>

        <!-- IMAGEN (modo lectura, tras guardar fallback garantizado) -->
        <div class="meal-section meal-image" *ngIf="!editMode">
          <h4>Imagen</h4>
          <img
            [src]="m.img_url"
            alt="Foto comida"
            class="meal-img"
          />
        </div>
      </div>
    </div>
  </div>

  <!-- BOTONES FINALES -->
  <div class="buttons">
    <button
      type="button"
      *ngIf="!editMode"
      class="btn-edit"
      (click)="toggleEdit()"
    >
      Editar
    </button>
    <button
      type="button"
      *ngIf="editMode"
      class="btn-save"
      [disabled]="saving"
      (click)="saveEdit()"
    >
      {{ saving ? 'Guardando…' : 'Guardar' }}
    </button>
    <button
      type="button"
      class="btn-delete"
      (click)="deleteDiet()"
    >
      Eliminar
    </button>
    <button
      type="button"
      class="btn-cancel"
      (click)="cancel()"
    >
      Cerrar
    </button>
  </div>
</div>
