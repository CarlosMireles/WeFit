<div class="view-container" *ngIf="diet">
  <!-- HEADER -->
  <div class="header">
    <ng-container *ngIf="!editMode; else editTitle">
      <h1>{{ diet.title }}</h1>
    </ng-container>
    <ng-template #editTitle>
      <input
        type="text"
        [(ngModel)]="updated.title"
        placeholder="'diet-view.title' | translate"
      />
    </ng-template>
  </div>

  <!-- DESCRIPCIÓN GENERAL -->
  <div class="section overview">
    <label>{{ 'diet-view.description' | translate }}</label>
    <ng-container *ngIf="!editMode; else editDesc">
      <p>{{ diet.description1 }}</p>
    </ng-container>
    <ng-template #editDesc>
      <textarea
        [(ngModel)]="updated.description1"
        placeholder="'diet-view.description' | translate"
      ></textarea>
    </ng-template>
  </div>

  <!-- COMIDAS -->
  <div class="section">
    <div class="meals-header">
      <h2>{{ 'diet-view.meals' | translate }} ({{ editMode ? updated.meals.length : diet.meals.length }})</h2>
      <button
        *ngIf="editMode"
        class="btn-add"
        [disabled]="updated.meals.length >= 10"
        (click)="addMeal()"
      >
        {{ 'diet-view.add-meal' | translate }}
      </button>
    </div>

    <div class="meals">
      <div
        *ngFor="let m of (editMode ? updated.meals : diet.meals); let i = index"
        class="meal-card"
      >
        <div class="meal-section meal-title">
          <h4>{{ 'diet-view.meal' | translate }}</h4>
          <div class="title-row">
            <ng-container *ngIf="!editMode; else editMealTitle">
              <h3>{{ m.lunch }}</h3>
            </ng-container>
            <ng-template #editMealTitle>
              <input
                type="text"
                [(ngModel)]="updated.meals[i].lunch"
                placeholder="'diet-view.name' | translate"
              />
            </ng-template>
            <button
              *ngIf="editMode"
              class="btn-remove"
              [disabled]="updated.meals.length <= 1"
              (click)="removeMeal(i)"
            >
              ×
            </button>
          </div>
        </div>

        <div class="meal-section meal-content">
          <h4>{{ 'diet-view.meal-content' | translate }}</h4>
          <ng-container *ngIf="!editMode; else editMeal">
            <p>{{ m.description2 }}</p>
          </ng-container>
          <ng-template #editMeal>
            <textarea
              [(ngModel)]="updated.meals[i].description2"
              placeholder="'diet-view.details' | translate"
            ></textarea>
          </ng-template>
        </div>

        <div
          class="meal-section meal-macros"
          *ngIf="
            !editMode &&
            (m.proteins || m.carbohydrates || m.fats || m.calories)
          "
        >
          <h4>{{ 'diet-view.macros' | translate }}</h4>
          <ul class="macros">
            <li *ngIf="m.proteins">{{ 'diet-view.proteins' | translate }} {{ m.proteins }} g</li>
            <li *ngIf="m.carbohydrates">
              {{ 'diet-view.carbohydrates' | translate }} {{ m.carbohydrates }} g
            </li>
            <li *ngIf="m.fats">{{ 'diet-view.fats' | translate }} {{ m.fats }} g</li>
            <li *ngIf="m.calories">{{ 'diet-view.calories' | translate }} {{ m.calories }} kcal</li>
          </ul>
        </div>

        <ng-container *ngIf="editMode">
          <div class="meal-section meal-macros">
            <h4>{{ 'diet-view.macros' | translate }}</h4>
            <div class="inputs-row">
              <input
                type="number"
                [(ngModel)]="updated.meals[i].proteins"
                placeholder="'diet-view.proteins-ph' | translate"
              />
              <input
                type="number"
                [(ngModel)]="updated.meals[i].carbohydrates"
                placeholder="'diet-view.carbohydrates-ph' | translate"
              />
            </div>
            <div class="inputs-row">
              <input
                type="number"
                [(ngModel)]="updated.meals[i].fats"
                placeholder="'diet-view.fats-ph' | translate"
              />
              <input
                type="number"
                [(ngModel)]="updated.meals[i].calories"
                placeholder="'diet-view.calories-ph' | translate"
              />
            </div>
          </div>
          <div class="meal-section meal-image">
            <h4>{{ 'diet-view.image' | translate }}</h4>
            <div class="file-input">
              <input
                type="file"
                accept="image/*"
                (change)="onFileSelected($event, updated.meals[i])"
              />
            </div>
            <img
              *ngIf="updated.meals[i].img_url"
              [src]="updated.meals[i].img_url"
              alt="Preview comida"
              class="meal-img"
            />
          </div>
        </ng-container>

        <div class="meal-section meal-image" *ngIf="!editMode">
          <h4>{{ 'diet-view.image' | translate }}</h4>
          <img
            [src]="m.img_url"
            alt="Foto comida"
            class="meal-img"
          />
        </div>
      </div>
    </div>
  </div>

  <!-- BOTONES FINALES -->
  <div class="buttons">
    <button
      *ngIf="isOwner && !editMode"
      class="btn-edit"
      (click)="toggleEdit()"
    >
      {{ 'diet-view.edit' | translate }}
    </button>
    <button
      *ngIf="isOwner && editMode"
      class="btn-save"
      [disabled]="saving"
      (click)="saveEdit()"
    >
      {{ saving ? 'Guardando…' : 'Guardar' }}
    </button>
    <button
      *ngIf="isOwner"
      class="btn-delete"
      (click)="deleteDiet()"
    >
      {{ 'diet-view.delete' | translate }}
    </button>
    <button
      class="btn-cancel"
      (click)="cancel()"
    >
      {{ 'diet-view.close' | translate }}
    </button>
  </div>
</div>
