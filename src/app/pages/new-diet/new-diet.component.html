<div class="new-diet-container">
  <h1>{{ 'new-diet.title' | translate }}</h1>

  <!-- FORMULARIO DE CREACIÓN -->
  <form (ngSubmit)="saveDiet()" #f="ngForm" novalidate>
    <!-- TÍTULO -->
    <label for="title">{{ 'new-diet.name' | translate }}</label>
    <input
      id="title"
      name="title"
      [(ngModel)]="model.title"
      required
    />

    <!-- DESCRIPCIÓN -->
    <label for="desc1">{{ 'new-diet.description' | translate }}</label>
    <textarea
      id="desc1"
      name="description1"
      [(ngModel)]="model.description1"
      required
    ></textarea>

    <!-- AÑADIR COMIDA -->
    <button
      type="button"
      class="btn-add-meal"
      (click)="addMeal()"
      [disabled]="model.meals.length >= 10"
    >
      {{ 'new-diet.add-meal' | translate }} ({{ model.meals.length }}/10)
    </button>

    <!-- BLOQUES DE COMIDA -->
    <div *ngFor="let meal of model.meals; let i = index" class="meal-block">
      <button
        type="button"
        class="remove-meal"
        (click)="removeMeal(i)"
        [disabled]="model.meals.length <= 1"
      >
        ×
      </button>

      <h3>{{ 'new-diet.meal' | translate }} {{ i + 1 }}</h3>

      <label for="lunch-{{i}}">{{ 'new-diet.mealOfTheDay' | translate }}</label>
      <input
        id="lunch-{{i}}"
        name="lunch-{{i}}"
        [(ngModel)]="meal.lunch"
        required
      />

      <label for="desc2-{{i}}">{{ 'new-diet.meal-content' | translate }}</label>
      <textarea
        id="desc2-{{i}}"
        name="description2-{{i}}"
        [(ngModel)]="meal.description2"
        required
      ></textarea>

      <label for="prot-{{i}}">{{ 'diet-view.proteins-ph' | translate }}</label>
      <input
        id="prot-{{i}}"
        type="number"
        [(ngModel)]="meal.proteins"
        name="proteins-{{i}}"
      />

      <label for="carb-{{i}}">{{ 'diet-view.proteins-ph' | translate }}</label>
      <input
        id="carb-{{i}}"
        type="number"
        [(ngModel)]="meal.carbohydrates"
        name="carbohydrates-{{i}}"
      />

      <label for="fat-{{i}}">{{ 'diet-view.proteins-ph' | translate }}</label>
      <input
        id="fat-{{i}}"
        type="number"
        [(ngModel)]="meal.fats"
        name="fats-{{i}}"
      />

      <label for="cal-{{i}}">{{ 'new-diet.calories' | translate }}</label>
      <input
        id="cal-{{i}}"
        type="number"
        [(ngModel)]="meal.calories"
        name="calories-{{i}}"
      />

      <label for="img-{{i}}">{{ 'new-diet.image' | translate }}</label>
      <input
        id="img-{{i}}"
        type="file"
        accept="image/*"
        (change)="onFileSelected($event, i)"
      />

      <!-- siempre mostramos la vista previa: si hay img_url, la usamos; si no, el fallback -->
      <div class="preview">
        <img
          [src]="meal.img_url || 'assets/healthy-food.png'"
          class="meal-preview"
          alt="Previsualización comida {{ i + 1 }}"
        />
      </div>

      <hr />
    </div>

    <!-- BOTONES GUARDAR / CANCELAR -->
    <div class="form-buttons">
      <button
        type="submit"
        class="btn-save"
        [disabled]="f.invalid || isSaving || model.meals.length < 1"
      >
        {{ 'new-diet.save' | translate }}
      </button>
      <button
        type="button"
        class="btn-cancel"
        (click)="cancel()"
      >
        {{ 'new-diet.cancel' | translate }}
      </button>
    </div>
  </form>

  <!-- MENSAJE DE CONFIRMACIÓN -->
  <div *ngIf="savedDiet" class="confirmation">
    <p class="confirmation-text">
      {{ 'new-diet.confirmation' | translate }} “{{ savedDiet.title }}” {{ 'new-diet.confirmation2' | translate }}
    </p>
    <button class="btn-back" (click)="cancel()">
      {{ 'new-diet.return' | translate }}
    </button>
  </div>
</div>
